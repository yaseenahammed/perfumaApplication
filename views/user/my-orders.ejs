<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders - User</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out forwards',
                        'slide-up': 'slideUp 0.6s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(30px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        .order-card {
            transition: all 0.3s ease;
        }
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
        }
        .modal-content {
            background: white;
            margin: 15% auto;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <%- include("../../views/partials/user/header") %>
<div class="main-container">
    <main class="py-16">
        <div class="container mx-auto px-4">
            <div class="max-w-7xl mx-auto">
                <div class="bg-white rounded-2xl shadow-xl p-6 animate-slide-up">
                    <header class="text-center mb-8">
                        <form action="/my-orders" method="get" class="d-inline">
                            <div class="flex justify-center">
                                <div class="relative w-full max-w-md">
                                    <input 
                                        id="searchOrder"
                                        type="text" 
                                        class="w-full border border-gray-200 rounded-full py-3 px-6 text-gray-600 focus:outline-none focus:ring-2 focus:ring-amber-500 bg-gray-50" 
                                        placeholder="Search By Order ID.." 
                                        name="search"
                                    >
                                    <button 
                                        class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-gradient-to-r from-amber-500 to-orange-500 text-white px-4 py-2 rounded-full hover:from-amber-600 hover:to-orange-600 transition duration-300"
                                        type="submit"
                                    >
                                        Search
                                    </button>
                                </div>
                            </div>
                        </form>
                    </header>

                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl lg:text-3xl font-bold text-gray-900 flex items-center">
                            <i class="fas fa-box-open text-amber-500 mr-3"></i>
                            My Orders
                        </h2>
                    </div>

                    <!-- Order Listing -->
                    <div class="space-y-6">
                        <% if (orders.length === 0) { %>
                            <p class="text-center text-gray-600">No orders found.</p>
                        <% } else { %>
                            <% orders.forEach(order => { %>
                                <div class="order-card bg-white p-4 rounded-lg border border-gray-100">
                                    <div class="flex items-center justify-between mb-4">
                                        <div>
                                            <h3 class="text-lg font-semibold text-gray-900">Order ID: <%= order.orderID %></h3>
                                            <p class="text-gray-600 text-sm">Date: <%= new Date(order.createdAt).toLocaleDateString() %></p>
                                            <p class="text-gray-800 font-medium">Total: ₹<%= order.totalAmount %></p>
                                            <p class="text-gray-800 font-medium">Status: <%= order.orderStatus %></p>
                                            <% if (order.orderStatus === 'ReturnRequest') { %>
                                                <p class="text-yellow-600 text-sm mt-1">Return request pending admin verification...</p>
                                            <% } else if (order.orderStatus === 'Returned') { %>
                                                <p class="text-green-600 text-sm mt-1">Return allowed, amount refunded to wallet.</p>
                                            <% } else if (order.orderStatus === 'Delivered' && order.returnRejected) { %>
                                                <p class="text-red-600 text-sm mt-1">Return request rejected.</p>
                                            <% } %>
                                        </div>
                                    </div>
                                    <div class="mt-4 flex justify-end gap-2">
                                        <a href="/userOrder-details/<%= order.orderID %>" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">View Details</a>
                                        <a href="/download-invoice/<%= order.orderID %>" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">Download Invoice</a>
                                        <% if (order.orderStatus === 'Processing' || order.orderStatus === 'Shipped') { %>
                                            <button onclick="showCancelModal('<%= order.orderID %>')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Cancel Order</button>
                                        <% } %>
                                        <% if (order.orderStatus === 'Delivered' && !order.returnRejected) { %>
                                            <button onclick="showReturnModal('<%= order.orderID %>')" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">Return Order</button>
                                        <% } %>
                                    </div>
                                </div>
                            <% }); %>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

        
    </main>
   <div class="pagination-container mt-8 flex justify-center items-center gap-2">
                        <% if (currentPage > 1) { %>
                            <a href="/admin/orderList?page=<%= currentPage - 1 %>&search=<%= encodeURIComponent(search || '') %>&sort=<%= sort %>&filter=<%= encodeURIComponent(filter || '') %>" class="bg-gray-50 text-amber-600 border-amber-500 hover:bg-amber-500 hover:text-white hover:border-amber-600 px-4 py-2 rounded-lg transition-all duration-200">« Previous</a>
                        <% } %>
                        <% for (let i = 1; i <= totalPages; i++) { %>
                            <% if (i === currentPage) { %>
                                <span class="current-page bg-amber-500 text-white border-amber-500 px-4 py-2 rounded-lg font-bold"><%= i %></span>
                            <% } else { %>
                                <a href="/admin/orderList?page=<%= i %>&search=<%= encodeURIComponent(search || '') %>&sort=<%= sort %>&filter=<%= encodeURIComponent(filter || '') %>" class="bg-gray-50 text-amber-600 border-amber-500 hover:bg-amber-500 hover:text-white hover:border-amber-600 px-4 py-2 rounded-lg transition-all duration-200"><%= i %></a>
                            <% } %>
                        <% } %>
                        <% if (currentPage < totalPages) { %>
                            <a href="/admin/orderList?page=<%= currentPage + 1 %>&search=<%= encodeURIComponent(search || '') %>&sort=<%= sort %>&filter=<%= encodeURIComponent(filter || '') %>" class="bg-gray-50 text-amber-600 border-amber-500 hover:bg-amber-500 hover:text-white hover:border-amber-600 px-4 py-2 rounded-lg transition-all duration-200">Next »</a>
                        <% } %>
                    </div>
    </div>

    
   

    <!-- Cancel Modal -->
    <div id="cancelModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Cancel Order</h3>
            <p class="text-gray-600 mb-4">Are you sure you want to cancel order <span id="cancelOrderID" class="font-semibold"></span>?</p>
            <textarea id="cancelReason" placeholder="Reason for cancellation (optional)" class="w-full border border-gray-200 rounded-lg p-2 mb-4"></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('cancel')" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Close</button>
                <button onclick="confirmCancel()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Confirm Cancel</button>
            </div>
        </div>
    </div>

    <!-- Return Modal -->
    <div id="returnModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Return Order</h3>
            <p class="text-gray-600 mb-4">Are you sure you want to return order <span id="returnOrderID" class="font-semibold"></span>?</p>
            <textarea id="returnReason" placeholder="Reason for return (mandatory)" class="w-full border border-gray-200 rounded-lg p-2 mb-4" required></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('return')" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Close</button>
               <button onclick="confirmReturn()" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">Confirm Return</button>

            </div>
        </div>
    </div>

    <script>
        function showCancelModal(orderID) {
            const modal = document.getElementById('cancelModal');
            document.getElementById('cancelOrderID').textContent = orderID;
            modal.style.display = 'block';
            document.getElementById('cancelReason').value = '';
        }

        function showReturnModal(orderID) {
            const modal = document.getElementById('returnModal');
            document.getElementById('returnOrderID').textContent = orderID;
            currentReturnOrderID = orderID;
            modal.style.display = 'block';
            document.getElementById('returnReason').value = '';
        }

        function closeModal(type) {
            document.getElementById(type === 'cancel' ? 'cancelModal' : 'returnModal').style.display = 'none';
        }

        async function confirmCancel() {
            const orderID = document.getElementById('cancelOrderID').textContent.trim();
            const reason = document.getElementById('cancelReason').value.trim();

            try {
                const response = await fetch(`/cancel-order/${orderID}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });

                const data = await response.json();

                if (response.ok) {
                    Swal.fire('Success', data.message || 'Order cancelled successfully', 'success');
                    closeModal('cancel');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    Swal.fire('Error', data.message || 'Failed to cancel order', 'error');
                }
            } catch (error) {
                console.error('Cancel order error:', error);
                Swal.fire('Error', 'Something went wrong. Please try again.', 'error');
            }
        }


let currentReturnOrderID = null;

async function confirmReturn() {
    const reason = document.getElementById('returnReason').value.trim();

    if (!reason) {
        Swal.fire('Please provide a reason for return.');
        return;
    }

    if (!currentReturnOrderID) {
        Swal.fire('Invalid order ID');
        return;
    }

    try {
        console.log("Submitting return for Order ID:", currentReturnOrderID);

        const response = await fetch(`/return-order/${currentReturnOrderID}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reason })
        });

        const data = await response.json();

        if (response.ok) {
            Swal.fire('Success', data.message || 'Return request submitted successfully', 'success');
            closeModal('return');
            setTimeout(() => location.reload(), 1000);
        } else {
            Swal.fire('Error', data.message || 'Failed to submit return request', 'error');
        }
    } catch (error) {
        console.error('Return order error:', error);
        Swal.fire('Error', 'Something went wrong. Please try again.', 'error');
    }
}


        function searchOrders() {
            const searchTerm = document.getElementById('searchOrder').value;
            window.location.href = `/my-orders?search=${encodeURIComponent(searchTerm)}`;
        }
    </script>

    <%- include("../../views/partials/user/footer") %>
</body>
</html>